# é¡¹ç›®ç»“æ„è¯¦ç»†æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜é¡¹ç›®ä¸­æ¯ä¸ªæ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„åŠŸèƒ½ã€èŒè´£å’Œä½¿ç”¨æ–¹å¼ã€‚

---

## ğŸ“ ç›®å½•ç»“æ„æ€»è§ˆ

```
my-movie/
â”œâ”€â”€ config/                 # é…ç½®æ¨¡å—
â”œâ”€â”€ database/               # æ•°æ®åº“ç›¸å…³
â”œâ”€â”€ middleware/             # Expressä¸­é—´ä»¶
â”œâ”€â”€ routes/                # APIè·¯ç”±å±‚
â”œâ”€â”€ services/              # ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”œâ”€â”€ crawler/               # çˆ¬è™«è„šæœ¬
â”œâ”€â”€ public/                # å‰ç«¯é™æ€æ–‡ä»¶
â”œâ”€â”€ logs/                  # æ—¥å¿—æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ server.js              # æœåŠ¡å™¨å…¥å£
â”œâ”€â”€ package.json           # é¡¹ç›®é…ç½®
â””â”€â”€ README.md              # é¡¹ç›®è¯´æ˜
```

---

## ğŸ“‚ è¯¦ç»†ç›®å½•è¯´æ˜

### 1. `/config` - é…ç½®æ¨¡å—

**èŒè´£**: é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€æ—¥å¿—ã€å®‰å…¨ç­‰ã€‚

#### `config/database.js`
- **åŠŸèƒ½**: æ•°æ®åº“è¿æ¥æ± é…ç½®
- **å¯¼å‡º**: `pool`, `query`, `testConnection`
- **è¯´æ˜**: 
  - ä½¿ç”¨mysql2åˆ›å»ºè¿æ¥æ± 
  - æä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£
  - è‡ªåŠ¨ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸ
- **ä½¿ç”¨ç¤ºä¾‹**:
  ```javascript
  const { query } = require('./config/database');
  const users = await query('SELECT * FROM user WHERE id = ?', [userId]);
  ```

#### `config/logger.js`
- **åŠŸèƒ½**: Winstonæ—¥å¿—ç³»ç»Ÿé…ç½®
- **å¯¼å‡º**: `logger`, `logHelper`
- **è¯´æ˜**:
  - æ”¯æŒå¤šçº§åˆ«æ—¥å¿—ï¼ˆerror, warn, info, debugï¼‰
  - è‡ªåŠ¨å†™å…¥æ–‡ä»¶ï¼ˆerror.log, combined.logï¼‰
  - å¼€å‘ç¯å¢ƒåŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
  - æä¾›ä¾¿æ·çš„æ—¥å¿—å·¥å…·å‡½æ•°
- **æ—¥å¿—çº§åˆ«**:
  - `error`: é”™è¯¯æ—¥å¿—ï¼ˆå†™å…¥error.logï¼‰
  - `warn`: è­¦å‘Šæ—¥å¿—ï¼ˆå®‰å…¨äº‹ä»¶ï¼‰
  - `info`: ä¿¡æ¯æ—¥å¿—ï¼ˆAPIè¯·æ±‚ï¼‰
  - `debug`: è°ƒè¯•æ—¥å¿—ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
- **ä½¿ç”¨ç¤ºä¾‹**:
  ```javascript
  const { logHelper } = require('./config/logger');
  logHelper.logRequest(req, res, responseTime);
  logHelper.logError(error, { context: 'userService' });
  logHelper.logSecurity('Login failed', { userId, ip });
  ```

#### `config/security.js`
- **åŠŸèƒ½**: å®‰å…¨ç›¸å…³é…ç½®å’Œå·¥å…·å‡½æ•°
- **å¯¼å‡º**: 
  - `hashPassword`: å¯†ç åŠ å¯†ï¼ˆbcryptï¼‰
  - `comparePassword`: å¯†ç éªŒè¯
  - `generateToken`: ç”ŸæˆJWT token
  - `verifyToken`: éªŒè¯JWT token
  - `isAccountLocked`: æ£€æŸ¥è´¦æˆ·é”å®šçŠ¶æ€
  - `incrementLoginAttempts`: å¢åŠ ç™»å½•å¤±è´¥æ¬¡æ•°
  - `resetLoginAttempts`: é‡ç½®ç™»å½•å¤±è´¥æ¬¡æ•°
  - `updateLastLogin`: æ›´æ–°æœ€åç™»å½•æ—¶é—´
- **å®‰å…¨é…ç½®**:
  - å¯†ç åŠ å¯†: bcryptï¼Œ10è½®åŠ å¯†
  - JWTæœ‰æ•ˆæœŸ: 7å¤©ï¼ˆå¯é…ç½®ï¼‰
  - ç™»å½•é™åˆ¶: 5æ¬¡å¤±è´¥åé”å®š30åˆ†é’Ÿ
- **ä½¿ç”¨ç¤ºä¾‹**:
  ```javascript
  const { hashPassword, generateToken } = require('./config/security');
  const hashed = await hashPassword('password123');
  const token = generateToken({ userId: 1, username: 'admin' });
  ```

---

### 2. `/database` - æ•°æ®åº“ç›¸å…³

**èŒè´£**: æ•°æ®åº“è¿ç§»è„šæœ¬å’Œç»“æ„å®šä¹‰ã€‚

#### `database/migrations/001_initial_schema.sql`
- **åŠŸèƒ½**: å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„å®šä¹‰
- **åŒ…å«è¡¨**:
  1. `user`: ç”¨æˆ·è¡¨ï¼ˆæ”¯æŒé‚®ç®±ã€æ‰‹æœºå·ç™»å½•ï¼Œç™»å½•é™åˆ¶ï¼‰
  2. `genre`: ç”µå½±ç±»å‹è¡¨
  3. `movie`: ç”µå½±è¡¨ï¼ˆåŒºåˆ†trailerå’Œvideo_urlï¼Œæ”¯æŒå¤šç§è§†é¢‘ç±»å‹ï¼‰
  4. `rate`: è¯„åˆ†è¯„è®ºè¡¨
  5. `wish`: æ”¶è—è¡¨
  6. `operation_log`: æ“ä½œæ—¥å¿—è¡¨
- **ç‰¹ç‚¹**:
  - å®Œæ•´çš„ç´¢å¼•å®šä¹‰
  - å¤–é”®çº¦æŸ
  - å­—æ®µæ³¨é‡Š
  - æ”¯æŒä¸­æ–‡æ³¨é‡Š
- **æ‰§è¡Œæ–¹å¼**:
  ```bash
  mysql -u root -p family_movie < database/migrations/001_initial_schema.sql
  ```

#### `database/migrations/002_migrate_existing_data.sql`
- **åŠŸèƒ½**: ç°æœ‰æ•°æ®è¿ç§»è„šæœ¬
- **è¯´æ˜**: å°†æ—§è¡¨ç»“æ„çš„æ•°æ®è¿ç§»åˆ°æ–°è¡¨ç»“æ„
- **æ³¨æ„äº‹é¡¹**: æ‰§è¡Œå‰è¯·å¤‡ä»½æ•°æ®åº“

---

### 3. `/middleware` - Expressä¸­é—´ä»¶

**èŒè´£**: å¤„ç†HTTPè¯·æ±‚çš„ä¸­é—´ä»¶ï¼ŒåŒ…æ‹¬è®¤è¯ã€é”™è¯¯å¤„ç†ã€å®‰å…¨ç­‰ã€‚

#### `middleware/auth.js`
- **åŠŸèƒ½**: ç”¨æˆ·è®¤è¯å’Œæƒé™éªŒè¯
- **å¯¼å‡º**:
  - `authenticateToken`: éªŒè¯JWT token
  - `requireAdmin`: éªŒè¯ç®¡ç†å‘˜æƒé™
  - `authenticate`: ç»„åˆä¸­é—´ä»¶ï¼ˆè®¤è¯+è´¦æˆ·é”å®šæ£€æŸ¥ï¼‰
- **ä½¿ç”¨ç¤ºä¾‹**:
  ```javascript
  // éœ€è¦ç™»å½•
  router.get('/profile', authenticateToken, handler);
  
  // éœ€è¦ç®¡ç†å‘˜æƒé™
  router.post('/admin/movies', authenticateToken, requireAdmin, handler);
  
  // ç»„åˆä½¿ç”¨
  router.get('/wishlist', ...authenticate, handler);
  ```

#### `middleware/common.js`
- **åŠŸèƒ½**: é€šç”¨ä¸­é—´ä»¶
- **åŒ…å«**:
  - CORSè·¨åŸŸé…ç½®
  - JSONè§£æ
  - URLç¼–ç è§£æ
  - é™æ€æ–‡ä»¶æœåŠ¡
- **è¯´æ˜**: åœ¨server.jsä¸­ç»Ÿä¸€åŠ è½½

#### `middleware/error.js`
- **åŠŸèƒ½**: ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- **è¯´æ˜**:
  - æ•è·æ‰€æœ‰æœªå¤„ç†çš„é”™è¯¯
  - è½¬æ¢ä¸ºç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
  - è®°å½•é”™è¯¯æ—¥å¿—
  - å¼€å‘ç¯å¢ƒè¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
- **ä½¿ç”¨**: åœ¨server.jsæœ€ååŠ è½½

#### `middleware/security.js`
- **åŠŸèƒ½**: å®‰å…¨ç›¸å…³ä¸­é—´ä»¶
- **åŒ…å«**:
  - `checkAccountLock`: æ£€æŸ¥è´¦æˆ·é”å®šçŠ¶æ€
  - `rateLimiter`: APIè¯·æ±‚é™æµï¼ˆ15åˆ†é’Ÿ100æ¬¡ï¼‰
  - `loginLimiter`: ç™»å½•é™æµï¼ˆ15åˆ†é’Ÿ5æ¬¡ï¼‰
  - `logOperation`: è®°å½•æ“ä½œæ—¥å¿—
- **ä½¿ç”¨ç¤ºä¾‹**:
  ```javascript
  const { rateLimiter, checkAccountLock } = require('./middleware/security');
  router.use(rateLimiter);
  ```

---

### 4. `/routes` - APIè·¯ç”±å±‚

**èŒè´£**: å®šä¹‰APIç«¯ç‚¹ï¼Œå¤„ç†HTTPè¯·æ±‚ï¼Œè°ƒç”¨æœåŠ¡å±‚ã€‚

#### `routes/movies.js`
- **åŠŸèƒ½**: ç”µå½±ç›¸å…³API
- **è·¯ç”±**:
  - `GET /api/movies`: è·å–ç”µå½±åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µã€ç­›é€‰ã€æœç´¢ï¼‰
  - `GET /api/movies/:id`: è·å–ç”µå½±è¯¦æƒ…
  - `GET /api/movies/genres/list`: è·å–ç±»å‹åˆ—è¡¨
  - `GET /api/movies/hot/list`: è·å–çƒ­é—¨ç”µå½±
- **è¯´æ˜**: è°ƒç”¨`movieService`å¤„ç†ä¸šåŠ¡é€»è¾‘

#### `routes/users.js`
- **åŠŸèƒ½**: ç”¨æˆ·ç›¸å…³API
- **è·¯ç”±**:
  - `POST /api/users/register`: ç”¨æˆ·æ³¨å†Œ
  - `POST /api/users/login`: ç”¨æˆ·ç™»å½•
  - `GET /api/users/me`: è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€ç™»å½•ï¼‰
  - `PUT /api/users/me`: æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€ç™»å½•ï¼‰
  - `GET /api/users/wishlist`: è·å–æ”¶è—åˆ—è¡¨ï¼ˆéœ€ç™»å½•ï¼‰
- **è¯´æ˜**: è°ƒç”¨`userService`å¤„ç†ä¸šåŠ¡é€»è¾‘

#### `routes/rates.js`
- **åŠŸèƒ½**: è¯„åˆ†è¯„è®ºAPI
- **è·¯ç”±**:
  - `POST /api/rates`: æ·»åŠ è¯„åˆ†å’Œè¯„è®ºï¼ˆéœ€ç™»å½•ï¼‰
  - `GET /api/rates/movie/:movieId`: è·å–ç”µå½±è¯„è®ºåˆ—è¡¨
  - `DELETE /api/rates/:id`: åˆ é™¤è¯„è®ºï¼ˆéœ€ç™»å½•ï¼‰
- **è¯´æ˜**: æ”¯æŒè¯„åˆ†å’ŒçŸ­è¯„

#### `routes/wishlist.js`
- **åŠŸèƒ½**: æ”¶è—ç®¡ç†API
- **è·¯ç”±**:
  - `POST /api/wishlist`: æ·»åŠ æ”¶è—ï¼ˆéœ€ç™»å½•ï¼‰
  - `DELETE /api/wishlist/:movieId`: åˆ é™¤æ”¶è—ï¼ˆéœ€ç™»å½•ï¼‰
  - `GET /api/wishlist/check/:movieId`: æ£€æŸ¥æ˜¯å¦å·²æ”¶è—ï¼ˆéœ€ç™»å½•ï¼‰
- **è¯´æ˜**: æ”¯æŒå¤šç§æ”¶è—çŠ¶æ€ï¼ˆwant/watched/favoriteï¼‰

#### `routes/admin.js`
- **åŠŸèƒ½**: ç®¡ç†å‘˜åŠŸèƒ½API
- **è·¯ç”±**:
  - `POST /api/admin/movies`: æ·»åŠ ç”µå½±ï¼ˆéœ€ç®¡ç†å‘˜ï¼‰
  - `PUT /api/admin/movies/:id`: æ›´æ–°ç”µå½±ï¼ˆéœ€ç®¡ç†å‘˜ï¼‰
  - `DELETE /api/admin/movies/:id`: åˆ é™¤ç”µå½±ï¼ˆéœ€ç®¡ç†å‘˜ï¼‰
  - `POST /api/admin/genres`: æ·»åŠ ç±»å‹ï¼ˆéœ€ç®¡ç†å‘˜ï¼‰
  - `GET /api/admin/users`: è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆéœ€ç®¡ç†å‘˜ï¼‰
  - `GET /api/admin/stats`: è·å–ç»Ÿè®¡æ•°æ®ï¼ˆéœ€ç®¡ç†å‘˜ï¼‰
- **è¯´æ˜**: æ‰€æœ‰è·¯ç”±éƒ½éœ€è¦`authenticateToken + requireAdmin`

#### `routes/home.js`
- **åŠŸèƒ½**: é¦–é¡µå’ŒAPIæ–‡æ¡£
- **è·¯ç”±**:
  - `GET /`: é¦–é¡µï¼ˆé‡å®šå‘åˆ°index.htmlï¼‰
  - `GET /api`: APIæ–‡æ¡£é¡µé¢
- **è¯´æ˜**: æä¾›ç®€å•çš„APIæ–‡æ¡£å±•ç¤º

---

### 5. `/services` - ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚

**èŒè´£**: å°è£…ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ•°æ®åº“äº¤äº’ï¼Œæ•°æ®è½¬æ¢ã€‚

#### `services/userService.js`
- **åŠŸèƒ½**: ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
- **æ–¹æ³•**:
  - `register(userData)`: ç”¨æˆ·æ³¨å†Œ
  - `login(credentials)`: ç”¨æˆ·ç™»å½•
  - `getUserById(userId)`: è·å–ç”¨æˆ·ä¿¡æ¯
  - `updateUser(userId, userData)`: æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  - `getWishlist(userId, status)`: è·å–æ”¶è—åˆ—è¡¨
- **è¯´æ˜**: 
  - å¤„ç†å¯†ç åŠ å¯†
  - å¤„ç†ç™»å½•é™åˆ¶
  - ç”ŸæˆJWT token
  - è®°å½•æ“ä½œæ—¥å¿—

#### `services/movieService.js`
- **åŠŸèƒ½**: ç”µå½±ä¸šåŠ¡é€»è¾‘
- **æ–¹æ³•**:
  - `getMovies(params)`: è·å–ç”µå½±åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ã€åˆ†é¡µï¼‰
  - `getMovieById(id)`: è·å–ç”µå½±è¯¦æƒ…ï¼ˆåŒ…å«è¯„åˆ†ã€è¯„è®ºã€æ¨èï¼‰
  - `createMovie(movieData)`: åˆ›å»ºç”µå½±
  - `updateMovie(id, movieData)`: æ›´æ–°ç”µå½±
  - `deleteMovie(id)`: åˆ é™¤ç”µå½±
  - `getHotMovies(limit)`: è·å–çƒ­é—¨ç”µå½±
  - `getGenres()`: è·å–ç±»å‹åˆ—è¡¨
- **è¯´æ˜**: 
  - å¤„ç†åˆ†é¡µé€»è¾‘
  - å¤„ç†è¯„åˆ†ç»Ÿè®¡
  - å¤„ç†æ¨èç®—æ³•
  - è®°å½•æ“ä½œæ—¥å¿—

#### `services/storage.js`
- **åŠŸèƒ½**: æ–‡ä»¶å­˜å‚¨æœåŠ¡
- **æ”¯æŒ**: æœ¬åœ°å­˜å‚¨å’ŒOSSï¼ˆå¯¹è±¡å­˜å‚¨æœåŠ¡ï¼‰
- **æ–¹æ³•**:
  - `saveFile(file, subfolder)`: ä¿å­˜æ–‡ä»¶
  - `deleteFile(filePath, fileType)`: åˆ é™¤æ–‡ä»¶
  - `getFileInfo(filePath, fileType)`: è·å–æ–‡ä»¶ä¿¡æ¯
  - `generateFileName(originalName)`: ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
- **é…ç½®**: é€šè¿‡ç¯å¢ƒå˜é‡`STORAGE_TYPE`é€‰æ‹©å­˜å‚¨æ–¹å¼
- **è¯´æ˜**: 
  - è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
  - æ”¯æŒå­æ–‡ä»¶å¤¹
  - è®°å½•æ–‡ä»¶å¤§å°å’Œè·¯å¾„

---

### 6. `/utils` - å·¥å…·å‡½æ•°

**èŒè´£**: æä¾›é€šç”¨çš„å·¥å…·å‡½æ•°ã€‚

#### `utils/errors.js`
- **åŠŸèƒ½**: ç»Ÿä¸€é”™è¯¯å¤„ç†
- **å¯¼å‡º**:
  - `ERROR_CODES`: é”™è¯¯ç å®šä¹‰
  - `AppError`: è‡ªå®šä¹‰é”™è¯¯ç±»
  - `createErrorResponse`: åˆ›å»ºé”™è¯¯å“åº”
  - `errorHandler`: é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- **é”™è¯¯ç åˆ†ç±»**:
  - 1000-1999: é€šç”¨é”™è¯¯
  - 2000-2999: è®¤è¯é”™è¯¯
  - 3000-3999: æƒé™é”™è¯¯
  - 4000-4999: èµ„æºé”™è¯¯
  - 5000-5999: ä¸šåŠ¡é”™è¯¯
- **ä½¿ç”¨ç¤ºä¾‹**:
  ```javascript
  const { AppError, ERROR_CODES } = require('./utils/errors');
  throw new AppError(ERROR_CODES.USER_NOT_FOUND, null, 404);
  ```

#### `utils/paginate.js`
- **åŠŸèƒ½**: SQLåˆ†é¡µå·¥å…·
- **å¯¼å‡º**: `paginate(sql, params, page, limit)`
- **è¯´æ˜**: 
  - è‡ªåŠ¨æ‹¼æ¥LIMITå’ŒOFFSET
  - å¤„ç†å‚æ•°ç±»å‹è½¬æ¢
  - è¿”å›æœ€ç»ˆçš„SQLå’Œå‚æ•°
- **ä½¿ç”¨ç¤ºä¾‹**:
  ```javascript
  const { paginate } = require('./utils/paginate');
  const { sql, params } = paginate(baseSql, baseParams, page, limit);
  const results = await query(sql, params);
  ```

---

### 7. `/crawler` - çˆ¬è™«è„šæœ¬

**èŒè´£**: å®šæ—¶æŠ“å–ç”µå½±æ•°æ®ã€‚

#### `crawler/tmdbDaily.js`
- **åŠŸèƒ½**: ä»TMDB APIæŠ“å–æ¯æ—¥çƒ­é—¨ç”µå½±
- **è¯´æ˜**:
  - åªæŠ“å–é¢„å‘Šç‰‡ï¼ˆå†™å…¥`trailer`å­—æ®µï¼‰
  - `video_url`ç•™ç©ºï¼Œç­‰å¾…ç®¡ç†å‘˜ä¸Šä¼ æ­£ç‰‡
  - è‡ªåŠ¨è¯†åˆ«è§†é¢‘ç±»å‹
  - æ”¯æŒå»é‡ï¼ˆON DUPLICATE KEY UPDATEï¼‰
- **é…ç½®**: éœ€è¦TMDB API Keyï¼ˆç¯å¢ƒå˜é‡ï¼‰
- **æ‰§è¡Œ**: å¯é€šè¿‡cronå®šæ—¶æ‰§è¡Œ

#### `crawler/schedule.js`
- **åŠŸèƒ½**: å®šæ—¶ä»»åŠ¡é…ç½®
- **è¯´æ˜**: ä½¿ç”¨node-croné…ç½®å®šæ—¶ä»»åŠ¡
- **ç¤ºä¾‹**: æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œçˆ¬è™«

---

### 8. `/public` - å‰ç«¯é™æ€æ–‡ä»¶

**èŒè´£**: å‰ç«¯é¡µé¢ã€æ ·å¼ã€è„šæœ¬ã€è§†é¢‘æ–‡ä»¶ã€‚

#### `public/*.html`
- **åŠŸèƒ½**: HTMLé¡µé¢
- **é¡µé¢**:
  - `index.html`: é¦–é¡µ
  - `movies.html`: ç”µå½±åˆ—è¡¨é¡µ
  - `movie-detail.html`: ç”µå½±è¯¦æƒ…é¡µ
  - `login.html`: ç™»å½•æ³¨å†Œé¡µ
  - `user.html`: ç”¨æˆ·ä¸­å¿ƒ
  - `admin.html`: ç®¡ç†åå°

#### `public/css/style.css`
- **åŠŸèƒ½**: å…¨å±€æ ·å¼æ–‡ä»¶
- **åŒ…å«**: 
  - å¯¼èˆªæ æ ·å¼
  - ç”µå½±å¡ç‰‡æ ·å¼
  - è¡¨å•æ ·å¼
  - æ’­æ”¾å™¨æ ·å¼
  - å“åº”å¼å¸ƒå±€

#### `public/js/api.js`
- **åŠŸèƒ½**: APIè°ƒç”¨å°è£…
- **å¯¼å‡º**: 
  - `movieAPI`: ç”µå½±ç›¸å…³API
  - `userAPI`: ç”¨æˆ·ç›¸å…³API
  - `rateAPI`: è¯„åˆ†ç›¸å…³API
  - `wishlistAPI`: æ”¶è—ç›¸å…³API
  - `adminAPI`: ç®¡ç†å‘˜API
- **è¯´æ˜**: ç»Ÿä¸€å¤„ç†tokenã€é”™è¯¯ç­‰

#### `public/js/auth.js`
- **åŠŸèƒ½**: è®¤è¯ç›¸å…³å‡½æ•°
- **åŒ…å«**: 
  - ç™»å½•çŠ¶æ€æ£€æŸ¥
  - Tokenç®¡ç†
  - ç”¨æˆ·ä¿¡æ¯è·å–
  - ç™»å‡ºåŠŸèƒ½

#### `public/js/index.js`
- **åŠŸèƒ½**: é¦–é¡µé€»è¾‘
- **åŒ…å«**: 
  - åŠ è½½ç”µå½±ç±»å‹
  - åŠ è½½çƒ­é—¨ç”µå½±
  - åŠ è½½ç”µå½±åˆ—è¡¨
  - æœç´¢åŠŸèƒ½

#### `public/js/movies.js`
- **åŠŸèƒ½**: ç”µå½±åˆ—è¡¨é¡µé€»è¾‘
- **åŒ…å«**: 
  - ç­›é€‰åŠŸèƒ½
  - åˆ†é¡µåŠŸèƒ½
  - æœç´¢åŠŸèƒ½

#### `public/js/movie-detail.js`
- **åŠŸèƒ½**: ç”µå½±è¯¦æƒ…é¡µé€»è¾‘
- **åŒ…å«**: 
  - åŠ è½½ç”µå½±è¯¦æƒ…
  - æ’­æ”¾å™¨åˆå§‹åŒ–
  - è¯„è®ºåŠŸèƒ½
  - æ”¶è—åŠŸèƒ½
- **æ’­æ”¾å™¨æ”¯æŒ**:
  - æœ¬åœ°MP4æ–‡ä»¶
  - HLSæµåª’ä½“ï¼ˆ.m3u8ï¼‰
  - YouTubeåµŒå…¥
  - OSSé“¾æ¥

#### `public/js/login.js`
- **åŠŸèƒ½**: ç™»å½•æ³¨å†Œé€»è¾‘
- **åŒ…å«**: 
  - æ³¨å†Œè¡¨å•å¤„ç†
  - ç™»å½•è¡¨å•å¤„ç†
  - è¡¨å•éªŒè¯

#### `public/js/user.js`
- **åŠŸèƒ½**: ç”¨æˆ·ä¸­å¿ƒé€»è¾‘
- **åŒ…å«**: 
  - ä¸ªäººä¿¡æ¯å±•ç¤º
  - æ”¶è—åˆ—è¡¨
  - ä¿¡æ¯æ›´æ–°

#### `public/js/admin.js`
- **åŠŸèƒ½**: ç®¡ç†åå°é€»è¾‘
- **åŒ…å«**: 
  - ç»Ÿè®¡æ•°æ®å±•ç¤º
  - ç”µå½±ç®¡ç†
  - ç”¨æˆ·ç®¡ç†
  - ç±»å‹ç®¡ç†

#### `public/videos/`
- **åŠŸèƒ½**: è§†é¢‘æ–‡ä»¶å­˜å‚¨ç›®å½•
- **è¯´æ˜**: 
  - æœ¬åœ°å­˜å‚¨çš„è§†é¢‘æ–‡ä»¶
  - é€šè¿‡Expressé™æ€æ–‡ä»¶æœåŠ¡è®¿é—®
  - è·¯å¾„: `/videos/filename.mp4`

---

### 9. `/logs` - æ—¥å¿—æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

**èŒè´£**: å­˜å‚¨åº”ç”¨æ—¥å¿—ã€‚

- `error.log`: é”™è¯¯æ—¥å¿—
- `combined.log`: æ‰€æœ‰æ—¥å¿—

---

### 10. æ ¹ç›®å½•æ–‡ä»¶

#### `server.js`
- **åŠŸèƒ½**: æœåŠ¡å™¨å…¥å£æ–‡ä»¶
- **èŒè´£**:
  - åˆå§‹åŒ–Expressåº”ç”¨
  - åŠ è½½ä¸­é—´ä»¶
  - æ³¨å†Œè·¯ç”±
  - å¯åŠ¨æœåŠ¡å™¨
- **æµç¨‹**:
  1. æµ‹è¯•æ•°æ®åº“è¿æ¥
  2. åŠ è½½é€šç”¨ä¸­é—´ä»¶
  3. æ³¨å†Œä¸šåŠ¡è·¯ç”±
  4. åŠ è½½é”™è¯¯å¤„ç†ä¸­é—´ä»¶
  5. å¯åŠ¨HTTPæœåŠ¡å™¨

#### `package.json`
- **åŠŸèƒ½**: é¡¹ç›®é…ç½®æ–‡ä»¶
- **åŒ…å«**: 
  - é¡¹ç›®ä¿¡æ¯
  - ä¾èµ–åŒ…
  - è„šæœ¬å‘½ä»¤
- **ä¸»è¦ä¾èµ–**:
  - `express`: Webæ¡†æ¶
  - `mysql2`: MySQLé©±åŠ¨
  - `jsonwebtoken`: JWTè®¤è¯
  - `bcryptjs`: å¯†ç åŠ å¯†
  - `winston`: æ—¥å¿—ç³»ç»Ÿ
  - `multer`: æ–‡ä»¶ä¸Šä¼ 
  - `express-rate-limit`: è¯·æ±‚é™æµ

#### `README.md`
- **åŠŸèƒ½**: é¡¹ç›®è¯´æ˜æ–‡æ¡£
- **åŒ…å«**: 
  - é¡¹ç›®ç®€ä»‹
  - å¿«é€Ÿå¼€å§‹
  - åŠŸèƒ½è¯´æ˜
  - å¸¸è§é—®é¢˜

#### `ARCHITECTURE.md`
- **åŠŸèƒ½**: æ¶æ„è®¾è®¡æ–‡æ¡£
- **åŒ…å«**: 
  - æ¶æ„è®¾è®¡
  - æ¨¡å—è¯´æ˜
  - å®‰å…¨æœºåˆ¶
  - æ•°æ®åº“è®¾è®¡

---

## ğŸ”„ æ•°æ®æµ

### è¯·æ±‚å¤„ç†æµç¨‹

```
1. å®¢æˆ·ç«¯è¯·æ±‚
   â†“
2. middleware/common.js (CORS, JSONè§£æ)
   â†“
3. middleware/security.js (é™æµã€è´¦æˆ·æ£€æŸ¥)
   â†“
4. middleware/auth.js (è®¤è¯ã€æƒé™éªŒè¯)
   â†“
5. routes/*.js (è·¯ç”±å¤„ç†)
   â†“
6. services/*.js (ä¸šåŠ¡é€»è¾‘)
   â†“
7. config/database.js (æ•°æ®åº“æ“ä½œ)
   â†“
8. è¿”å›å“åº”
   â†“
9. middleware/error.js (é”™è¯¯å¤„ç†)
```

### ç”¨æˆ·æ³¨å†Œæµç¨‹

```
1. å‰ç«¯æäº¤æ³¨å†Œä¿¡æ¯
   â†“
2. routes/users.js æ¥æ”¶è¯·æ±‚
   â†“
3. userService.register() éªŒè¯æ•°æ®
   â†“
4. security.hashPassword() åŠ å¯†å¯†ç 
   â†“
5. database.query() å†™å…¥æ•°æ®åº“
   â†“
6. logger.logDatabase() è®°å½•æ—¥å¿—
   â†“
7. è¿”å›æˆåŠŸå“åº”
```

### ç”µå½±æ’­æ”¾æµç¨‹

```
1. å‰ç«¯è¯·æ±‚ç”µå½±è¯¦æƒ…
   â†“
2. routes/movies.js å¤„ç†è¯·æ±‚
   â†“
3. movieService.getMovieById() è·å–æ•°æ®
   â†“
4. è¿”å›ç”µå½±ä¿¡æ¯ï¼ˆåŒ…å«video_urlå’Œvideo_typeï¼‰
   â†“
5. å‰ç«¯æ ¹æ®video_typeæ¸²æŸ“æ’­æ”¾å™¨
   - local: <video>æ ‡ç­¾
   - hls: HLS.jsæ’­æ”¾å™¨
   - external: iframeåµŒå…¥
   - oss: ç›´æ¥é“¾æ¥
```

---

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. è®¤è¯ä¸æˆæƒ
- **JWT Token**: 7å¤©æœ‰æ•ˆæœŸ
- **å¯†ç åŠ å¯†**: bcryptï¼Œ10è½®
- **è§’è‰²æ§åˆ¶**: user/adminä¸¤çº§

### 2. ç™»å½•ä¿æŠ¤
- **ç™»å½•é™æµ**: 15åˆ†é’Ÿå†…æœ€å¤š5æ¬¡
- **è´¦æˆ·é”å®š**: 5æ¬¡å¤±è´¥åé”å®š30åˆ†é’Ÿ
- **è‡ªåŠ¨é‡ç½®**: 15åˆ†é’Ÿåé‡ç½®å¤±è´¥æ¬¡æ•°

### 3. APIä¿æŠ¤
- **è¯·æ±‚é™æµ**: 15åˆ†é’Ÿå†…æœ€å¤š100æ¬¡
- **è´¦æˆ·é”å®šæ£€æŸ¥**: æ¯æ¬¡è¯·æ±‚éªŒè¯
- **æ“ä½œæ—¥å¿—**: è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### è¡¨å…³ç³»å›¾

```
user (ç”¨æˆ·)
  â”œâ”€â”€ rate (è¯„åˆ†è¯„è®º) [1:N]
  â”œâ”€â”€ wish (æ”¶è—) [1:N]
  â””â”€â”€ operation_log (æ“ä½œæ—¥å¿—) [1:N]

movie (ç”µå½±)
  â”œâ”€â”€ rate (è¯„åˆ†è¯„è®º) [1:N]
  â”œâ”€â”€ wish (æ”¶è—) [1:N]
  â””â”€â”€ genre (ç±»å‹) [N:1]
```

### å…³é”®å­—æ®µè¯´æ˜

#### userè¡¨
- `login_attempts`: ç™»å½•å¤±è´¥æ¬¡æ•°
- `locked_until`: è´¦æˆ·é”å®šåˆ°æœŸæ—¶é—´
- `last_login`: æœ€åç™»å½•æ—¶é—´

#### movieè¡¨
- `trailer`: é¢„å‘Šç‰‡URLï¼ˆYouTubeç­‰ï¼‰
- `video_url`: æ­£ç‰‡è§†é¢‘URLï¼ˆæœ¬åœ°æˆ–OSSï¼‰
- `video_type`: è§†é¢‘ç±»å‹ï¼ˆlocal/oss/external/hlsï¼‰
- `file_path`: æœ¬åœ°æ–‡ä»¶è·¯å¾„
- `file_size`: æ–‡ä»¶å¤§å°

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç¯å¢ƒå˜é‡é…ç½®

```env
# æ•°æ®åº“
DB_HOST=localhost
DB_PORT=3307
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=family_movie

# JWT
JWT_SECRET=your-secret-key-change-this
JWT_EXPIRES_IN=7d

# å­˜å‚¨
STORAGE_TYPE=local  # local | oss
STORAGE_LOCAL_PATH=./public/videos

# æ—¥å¿—
LOG_LEVEL=info
NODE_ENV=production
```

### æ•°æ®åº“è¿ç§»

```bash
# 1. å¤‡ä»½ç°æœ‰æ•°æ®åº“
mysqldump -u root -p family_movie > backup.sql

# 2. æ‰§è¡Œè¿ç§»è„šæœ¬
mysql -u root -p family_movie < database/migrations/001_initial_schema.sql
mysql -u root -p family_movie < database/migrations/002_migrate_existing_data.sql
```

---

## ğŸ“ å¼€å‘è§„èŒƒ

### 1. ä»£ç ç»„ç»‡
- **è·¯ç”±å±‚**: åªå¤„ç†HTTPè¯·æ±‚ï¼Œä¸åšä¸šåŠ¡é€»è¾‘
- **æœåŠ¡å±‚**: å°è£…ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ•°æ®åº“äº¤äº’
- **å·¥å…·å±‚**: æä¾›é€šç”¨å·¥å…·å‡½æ•°

### 2. é”™è¯¯å¤„ç†
- ä½¿ç”¨`AppError`æŠ›å‡ºä¸šåŠ¡é”™è¯¯
- ä½¿ç”¨`errorHandler`ç»Ÿä¸€å¤„ç†
- è®°å½•é”™è¯¯æ—¥å¿—

### 3. æ—¥å¿—è®°å½•
- APIè¯·æ±‚: `logHelper.logRequest()`
- é”™è¯¯: `logHelper.logError()`
- æ•°æ®åº“æ“ä½œ: `logHelper.logDatabase()`
- å®‰å…¨äº‹ä»¶: `logHelper.logSecurity()`

### 4. æ•°æ®åº“æ“ä½œ
- ä½¿ç”¨`query()`å‡½æ•°æ‰§è¡ŒSQL
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
- è®°å½•æ‰€æœ‰æ•°æ®åº“æ“ä½œæ—¥å¿—

---

## ğŸ”§ æ‰©å±•å»ºè®®

1. **ç¼“å­˜å±‚**: ä½¿ç”¨Redisç¼“å­˜çƒ­é—¨ç”µå½±æ•°æ®
2. **CDN**: è§†é¢‘æ–‡ä»¶ä½¿ç”¨CDNåŠ é€Ÿ
3. **æœç´¢**: é›†æˆElasticsearchå…¨æ–‡æœç´¢
4. **ç›‘æ§**: é›†æˆAPMå·¥å…·ï¼ˆå¦‚New Relicï¼‰
5. **æµ‹è¯•**: æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

**æœ€åæ›´æ–°**: 2024-11-20  
**ç‰ˆæœ¬**: 2.0.0

