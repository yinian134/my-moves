# é¡¹ç›®æ¶æ„æ–‡æ¡£

## ğŸ“ ç›®å½•ç»“æ„

```
my-movie/
â”œâ”€â”€ config/                 # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ database.js        # æ•°æ®åº“è¿æ¥é…ç½®
â”‚   â”œâ”€â”€ logger.js          # æ—¥å¿—ç³»ç»Ÿé…ç½®ï¼ˆWinstonï¼‰
â”‚   â””â”€â”€ security.js        # å®‰å…¨é…ç½®ï¼ˆå¯†ç åŠ å¯†ã€JWTã€ç™»å½•é™åˆ¶ï¼‰
â”‚
â”œâ”€â”€ database/              # æ•°æ®åº“ç›¸å…³
â”‚   â””â”€â”€ migrations/        # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚       â”œâ”€â”€ 001_initial_schema.sql      # åˆå§‹è¡¨ç»“æ„
â”‚       â””â”€â”€ 002_migrate_existing_data.sql # æ•°æ®è¿ç§»è„šæœ¬
â”‚
â”œâ”€â”€ middleware/             # Expressä¸­é—´ä»¶
â”‚   â”œâ”€â”€ auth.js           # ç”¨æˆ·è®¤è¯ä¸­é—´ä»¶ï¼ˆJWTéªŒè¯ã€ç®¡ç†å‘˜æƒé™ï¼‰
â”‚   â”œâ”€â”€ common.js         # é€šç”¨ä¸­é—´ä»¶ï¼ˆCORSã€JSONè§£æã€é™æ€æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ error.js          # é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”‚   â””â”€â”€ security.js       # å®‰å…¨ä¸­é—´ä»¶ï¼ˆé™æµã€è´¦æˆ·é”å®šæ£€æŸ¥ï¼‰
â”‚
â”œâ”€â”€ routes/                # APIè·¯ç”±å±‚
â”‚   â”œâ”€â”€ admin.js          # ç®¡ç†å‘˜è·¯ç”±ï¼ˆéœ€è¦adminæƒé™ï¼‰
â”‚   â”œâ”€â”€ home.js           # é¦–é¡µè·¯ç”±ï¼ˆAPIæ–‡æ¡£ï¼‰
â”‚   â”œâ”€â”€ movies.js         # ç”µå½±ç›¸å…³è·¯ç”±
â”‚   â”œâ”€â”€ rates.js          # è¯„åˆ†è¯„è®ºè·¯ç”±
â”‚   â”œâ”€â”€ users.js          # ç”¨æˆ·ç›¸å…³è·¯ç”±
â”‚   â””â”€â”€ wishlist.js       # æ”¶è—è·¯ç”±
â”‚
â”œâ”€â”€ services/              # ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
â”‚   â”œâ”€â”€ movieService.js   # ç”µå½±ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ userService.js    # ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ storage.js        # æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼ˆæœ¬åœ°/OSSï¼‰
â”‚
â”œâ”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ errors.js         # ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼ˆé”™è¯¯ç ã€é”™è¯¯ç±»ï¼‰
â”‚   â””â”€â”€ paginate.js       # åˆ†é¡µå·¥å…·
â”‚
â”œâ”€â”€ crawler/              # çˆ¬è™«è„šæœ¬
â”‚   â”œâ”€â”€ tmdbDaily.js      # TMDBæ¯æ—¥æ•°æ®æŠ“å–
â”‚   â””â”€â”€ schedule.js       # å®šæ—¶ä»»åŠ¡é…ç½®
â”‚
â”œâ”€â”€ public/               # å‰ç«¯é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ css/             # æ ·å¼æ–‡ä»¶
â”‚   â”œâ”€â”€ js/              # JavaScriptæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ api.js       # APIè°ƒç”¨å°è£…
â”‚   â”‚   â”œâ”€â”€ auth.js      # è®¤è¯ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ index.js     # é¦–é¡µé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ movies.js    # ç”µå½±åˆ—è¡¨é¡µ
â”‚   â”‚   â”œâ”€â”€ movie-detail.js # ç”µå½±è¯¦æƒ…é¡µ
â”‚   â”‚   â”œâ”€â”€ login.js     # ç™»å½•æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ user.js      # ç”¨æˆ·ä¸­å¿ƒ
â”‚   â”‚   â””â”€â”€ admin.js     # ç®¡ç†åå°
â”‚   â”œâ”€â”€ videos/          # è§†é¢‘æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
â”‚   â””â”€â”€ *.html           # HTMLé¡µé¢
â”‚
â”œâ”€â”€ logs/                 # æ—¥å¿—æ–‡ä»¶ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ error.log        # é”™è¯¯æ—¥å¿—
â”‚   â””â”€â”€ combined.log     # ç»¼åˆæ—¥å¿—
â”‚
â”œâ”€â”€ server.js             # æœåŠ¡å™¨å…¥å£æ–‡ä»¶
â”œâ”€â”€ package.json          # é¡¹ç›®é…ç½®
â””â”€â”€ README.md            # é¡¹ç›®è¯´æ˜
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å‰ç«¯å±‚ (Frontend)            â”‚
â”‚    HTML + CSS + JavaScript           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP/JSON
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         è·¯ç”±å±‚ (Routes)               â”‚
â”‚    å¤„ç†HTTPè¯·æ±‚ï¼Œå‚æ•°éªŒè¯              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æœåŠ¡å±‚ (Services)             â”‚
â”‚    ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæ•°æ®è½¬æ¢              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®å±‚ (Database)             â”‚
â”‚     MySQLæ•°æ®åº“æ“ä½œ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¨¡å—è¯´æ˜

#### **config/** - é…ç½®æ¨¡å—
- **database.js**: æ•°æ®åº“è¿æ¥æ± é…ç½®
- **logger.js**: Winstonæ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒæ–‡ä»¶å’Œæ§åˆ¶å°è¾“å‡º
- **security.js**: å®‰å…¨ç›¸å…³é…ç½®ï¼ˆå¯†ç åŠ å¯†ã€JWTã€ç™»å½•é™åˆ¶ï¼‰

#### **middleware/** - ä¸­é—´ä»¶æ¨¡å—
- **auth.js**: JWTè®¤è¯ã€ç®¡ç†å‘˜æƒé™éªŒè¯
- **common.js**: CORSã€JSONè§£æã€é™æ€æ–‡ä»¶æœåŠ¡
- **error.js**: ç»Ÿä¸€é”™è¯¯å¤„ç†
- **security.js**: è¯·æ±‚é™æµã€è´¦æˆ·é”å®šæ£€æŸ¥ã€æ“ä½œæ—¥å¿—

#### **routes/** - è·¯ç”±æ¨¡å—
- **admin.js**: ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆç”µå½±ç®¡ç†ã€ç”¨æˆ·ç®¡ç†ã€ç»Ÿè®¡æ•°æ®ï¼‰
- **movies.js**: ç”µå½±åˆ—è¡¨ã€è¯¦æƒ…ã€ç±»å‹ã€çƒ­é—¨
- **users.js**: ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¸ªäººä¿¡æ¯
- **rates.js**: è¯„åˆ†ã€è¯„è®º
- **wishlist.js**: æ”¶è—ç®¡ç†

#### **services/** - æœåŠ¡å±‚æ¨¡å—
- **movieService.js**: ç”µå½±ä¸šåŠ¡é€»è¾‘å°è£…
- **userService.js**: ç”¨æˆ·ä¸šåŠ¡é€»è¾‘å°è£…
- **storage.js**: æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼ˆæ”¯æŒæœ¬åœ°å’ŒOSSï¼‰

#### **utils/** - å·¥å…·æ¨¡å—
- **errors.js**: ç»Ÿä¸€é”™è¯¯ç ã€é”™è¯¯ç±»ã€é”™è¯¯å¤„ç†
- **paginate.js**: SQLåˆ†é¡µå·¥å…·

#### **database/migrations/** - æ•°æ®åº“è¿ç§»
- **001_initial_schema.sql**: å®Œæ•´çš„è¡¨ç»“æ„å®šä¹‰
- **002_migrate_existing_data.sql**: ç°æœ‰æ•°æ®è¿ç§»è„šæœ¬

---

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. è®¤è¯ä¸æˆæƒ
- **JWT Token**: 7å¤©æœ‰æ•ˆæœŸï¼Œå­˜å‚¨åœ¨localStorage
- **å¯†ç åŠ å¯†**: bcryptï¼Œ10è½®åŠ å¯†
- **è§’è‰²æ§åˆ¶**: user/adminä¸¤çº§æƒé™

### 2. ç™»å½•ä¿æŠ¤
- **ç™»å½•é™æµ**: 15åˆ†é’Ÿå†…æœ€å¤š5æ¬¡å°è¯•
- **è´¦æˆ·é”å®š**: 5æ¬¡å¤±è´¥åé”å®š30åˆ†é’Ÿ
- **è‡ªåŠ¨é‡ç½®**: 15åˆ†é’Ÿåé‡ç½®å¤±è´¥æ¬¡æ•°

### 3. APIä¿æŠ¤
- **è¯·æ±‚é™æµ**: 15åˆ†é’Ÿå†…æœ€å¤š100æ¬¡è¯·æ±‚
- **è´¦æˆ·é”å®šæ£€æŸ¥**: æ¯æ¬¡è¯·æ±‚éªŒè¯è´¦æˆ·çŠ¶æ€
- **æ“ä½œæ—¥å¿—**: è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„

1. **user** - ç”¨æˆ·è¡¨
   - æ”¯æŒé‚®ç®±ã€æ‰‹æœºå·ç™»å½•
   - ç™»å½•å¤±è´¥æ¬¡æ•°å’Œé”å®šæ—¶é—´
   - æœ€åç™»å½•æ—¶é—´è®°å½•

2. **movie** - ç”µå½±è¡¨
   - åŒºåˆ†trailerï¼ˆé¢„å‘Šç‰‡ï¼‰å’Œvideo_urlï¼ˆæ­£ç‰‡ï¼‰
   - video_typeå­—æ®µæ ‡è¯†è§†é¢‘ç±»å‹ï¼ˆlocal/oss/external/hlsï¼‰
   - æ”¯æŒæ–‡ä»¶å¤§å°å’Œè·¯å¾„è®°å½•

3. **rate** - è¯„åˆ†è¡¨
   - userId/movieIdå”¯ä¸€çº¦æŸ
   - è¯„åˆ†1-5åˆ†
   - çŸ­è¯„200å­—

4. **wish** - æ”¶è—è¡¨
   - çŠ¶æ€ï¼šwant/watched/favorite

5. **operation_log** - æ“ä½œæ—¥å¿—è¡¨
   - è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ
   - JSONæ ¼å¼å­˜å‚¨è¯¦ç»†ä¿¡æ¯

---

## ğŸ¬ è§†é¢‘å­˜å‚¨

### å­˜å‚¨æ–¹å¼
- **æœ¬åœ°å­˜å‚¨**: `public/videos/` ç›®å½•
- **OSSå­˜å‚¨**: é˜¿é‡Œäº‘OSSï¼ˆå¯é€‰ï¼‰
- **å¤–éƒ¨é“¾æ¥**: YouTubeç­‰ï¼ˆä»…ç”¨äºé¢„å‘Šç‰‡ï¼‰

### è§†é¢‘ç±»å‹
- **local**: æœ¬åœ°æ–‡ä»¶ï¼ˆMP4ç­‰ï¼‰
- **oss**: å¯¹è±¡å­˜å‚¨æœåŠ¡
- **external**: å¤–éƒ¨é“¾æ¥ï¼ˆYouTubeï¼‰
- **hls**: HLSæµåª’ä½“ï¼ˆ.m3u8ï¼‰

### çˆ¬è™«ç­–ç•¥
- **åªæŠ“å–é¢„å‘Šç‰‡**: å†™å…¥`trailer`å­—æ®µ
- **video_urlç•™ç©º**: ç­‰å¾…ç®¡ç†å‘˜ä¸Šä¼ æ­£ç‰‡
- **video_typeæ ‡è®°**: è‡ªåŠ¨è¯†åˆ«é“¾æ¥ç±»å‹

---

## ğŸ“ æ—¥å¿—ç³»ç»Ÿ

### æ—¥å¿—çº§åˆ«
- **error**: é”™è¯¯æ—¥å¿—ï¼ˆå†™å…¥error.logï¼‰
- **warn**: è­¦å‘Šæ—¥å¿—ï¼ˆå®‰å…¨äº‹ä»¶ï¼‰
- **info**: ä¿¡æ¯æ—¥å¿—ï¼ˆAPIè¯·æ±‚ï¼‰
- **debug**: è°ƒè¯•æ—¥å¿—ï¼ˆæ•°æ®åº“æ“ä½œï¼‰

### æ—¥å¿—å†…å®¹
- APIè¯·æ±‚ï¼ˆæ–¹æ³•ã€URLã€IPã€å“åº”æ—¶é—´ï¼‰
- é”™è¯¯ä¿¡æ¯ï¼ˆå †æ ˆã€ä¸Šä¸‹æ–‡ï¼‰
- å®‰å…¨äº‹ä»¶ï¼ˆç™»å½•å¤±è´¥ã€è´¦æˆ·é”å®šï¼‰
- æ•°æ®åº“æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç¯å¢ƒå˜é‡
```env
# æ•°æ®åº“
DB_HOST=localhost
DB_PORT=3307
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=family_movie

# JWT
JWT_SECRET=your-secret-key-change-this
JWT_EXPIRES_IN=7d

# å­˜å‚¨
STORAGE_TYPE=local  # local | oss
STORAGE_LOCAL_PATH=./public/videos

# OSSé…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY_ID=your_key
OSS_ACCESS_KEY_SECRET=your_secret
OSS_BUCKET=your_bucket

# æ—¥å¿—
LOG_LEVEL=info
NODE_ENV=production
```

### æ•°æ®åº“è¿ç§»
```bash
# 1. å¤‡ä»½ç°æœ‰æ•°æ®åº“
mysqldump -u root -p family_movie > backup.sql

# 2. æ‰§è¡Œè¿ç§»è„šæœ¬
mysql -u root -p family_movie < database/migrations/001_initial_schema.sql
mysql -u root -p family_movie < database/migrations/002_migrate_existing_data.sql
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### ç”¨æˆ·æ³¨å†Œæµç¨‹
1. å‰ç«¯æäº¤æ³¨å†Œä¿¡æ¯
2. routes/users.js æ¥æ”¶è¯·æ±‚
3. userService.register() éªŒè¯å¹¶åŠ å¯†å¯†ç 
4. å†™å…¥æ•°æ®åº“
5. è¿”å›æˆåŠŸå“åº”

### ç”µå½±æ’­æ”¾æµç¨‹
1. å‰ç«¯è¯·æ±‚ç”µå½±è¯¦æƒ…
2. routes/movies.js å¤„ç†è¯·æ±‚
3. movieService.getMovieById() è·å–æ•°æ®
4. å‰ç«¯æ ¹æ®video_typeæ¸²æŸ“å¯¹åº”æ’­æ”¾å™¨
5. æœ¬åœ°æ–‡ä»¶ç›´æ¥æ’­æ”¾ï¼ŒOSS/HLSä½¿ç”¨å¯¹åº”æŠ€æœ¯

### æ–‡ä»¶ä¸Šä¼ æµç¨‹
1. ç®¡ç†å‘˜ä¸Šä¼ è§†é¢‘æ–‡ä»¶
2. multerä¸­é—´ä»¶æ¥æ”¶æ–‡ä»¶
3. storage.saveFile() ä¿å­˜åˆ°æœ¬åœ°/OSS
4. æ›´æ–°movieè¡¨çš„video_urlå’Œfile_path
5. è¿”å›æ–‡ä»¶è®¿é—®è·¯å¾„

---

## ğŸ“š æ‰©å±•å»ºè®®

1. **ç¼“å­˜å±‚**: ä½¿ç”¨Redisç¼“å­˜çƒ­é—¨ç”µå½±æ•°æ®
2. **CDN**: è§†é¢‘æ–‡ä»¶ä½¿ç”¨CDNåŠ é€Ÿ
3. **æœç´¢**: é›†æˆElasticsearchå…¨æ–‡æœç´¢
4. **ç›‘æ§**: é›†æˆAPMå·¥å…·ï¼ˆå¦‚New Relicï¼‰
5. **æµ‹è¯•**: æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜
1. **æ•°æ®åº“è¿æ¥å¤±è´¥**: æ£€æŸ¥config/database.jsé…ç½®
2. **JWTéªŒè¯å¤±è´¥**: æ£€æŸ¥JWT_SECRETç¯å¢ƒå˜é‡
3. **æ–‡ä»¶ä¸Šä¼ å¤±è´¥**: æ£€æŸ¥å­˜å‚¨ç›®å½•æƒé™
4. **æ—¥å¿—ä¸è¾“å‡º**: æ£€æŸ¥logsç›®å½•æƒé™

---

**æœ€åæ›´æ–°**: 2024-11-20
**ç‰ˆæœ¬**: 2.0.0

